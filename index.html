
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Tube Station Heatmap</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <style>
        /* Custom CSS for map container to ensure it takes full height */
        #map {
            height: 80vh; /* Set a responsive height for the map */
            width: 100%;
            border-radius: 0.5rem; /* Apply rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
        }
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="container mx-auto p-4 bg-white rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4 rounded-md p-2 bg-blue-100">
            London Tube Station Busyness Heatmap
        </h1>
        <p class="text-center text-gray-600 mb-6">
            This heatmap visualizes the relative busyness of London tube stations based on live footfall data compared to baseline.
            Higher intensity (redder areas) indicates more crowding.
        </p>

        <!-- Map container -->
        <div id="map" class="mb-6"></div>

        <div class="text-center text-gray-500 text-sm">
            <p>Data Source: Processed data from your provided CSV files.</p>
            <p>Map tiles by <a href="https://www.openstreetmap.org/copyright" target="_blank" class="text-blue-500 hover:underline">OpenStreetMap</a> contributors.</p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <!-- Leaflet.heat JS for heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // Embed the processed station data directly into the HTML
        // This data was generated by the Python script from your CSV files.
        const stationData = JSON.parse(`[
  [
    51.479932,
    -0.142142,
    0.015188680860716222,
    "Battersea Power Station"
  ],
  [
    51.503057,
    -0.280462,
    0.021163253750912932,
    "Acton Town"
  ],
  [
    51.565478,
    -0.134819,
    0.018489186522860405,
    "Archway"
  ],
  [
    51.515037,
    -0.072384,
    0.03619167977938124,
    "Aldgate East"
  ],
  [
    51.531788,
    -0.105919,
    0.04585885512923471,
    "Angel"
  ],
  [
    51.514246,
    -0.075689,
    0.015777153698970547,
    "Aldgate"
  ],
  [
    51.540627,
    -0.29961,
    0.002430951192947473,
    "Alperton"
  ],
  [
    51.674126,
    -0.607714,
    0.004412141099366327,
    "Amersham"
  ],
  [
    51.616446,
    -0.133062,
    0.00664180226667596,
    "Arnos Grove"
  ],
  [
    51.558655,
    -0.107457,
    0.003821627928274658,
    "Arsenal"
  ],
  [
    51.524839,
    -0.011538,
    0.010653912041541785,
    "Bromley-by-Bow"
  ],
  [
    51.520275,
    -0.097993,
    0.03777422664517048,
    "Barbican"
  ],
  [
    51.607034,
    -0.124235,
    0.008919161577060498,
    "Bounds Green"
  ],
  [
    51.540331,
    0.127016,
    0.007828381496631624,
    "Becontree"
  ],
  [
    51.585689,
    0.088585,
    0.001978598494034505,
    "Barkingside"
  ],
  [
    51.511581,
    -0.103659,
    0.054311088249929536,
    "Blackfriars"
  ],
  [
    51.539321,
    0.081053,
    0.06571563963488807,
    "Barking"
  ],
  [
    51.626605,
    0.046757,
    0.0016812334060748951,
    "Buckhurst Hill"
  ],
  [
    51.527222,
    -0.055506,
    0.04180190249711346,
    "Bethnal Green"
  ],
  [
    51.443288,
    -0.152997,
    0.017425206825968768,
    "Balham"
  ],
  [
    51.586919,
    -0.04115,
    0.022237724327158228,
    "Blackhorse Road"
  ],
  [
    51.49775,
    -0.063993,
    0.02067761507262539,
    "Bermondsey"
  ],
  [
    51.514304,
    -0.149723,
    0.17193279626826996,
    "Bond Street"
  ],
  [
    51.513132,
    -0.090047,
    0.08338306512450716,
    "Bank"
  ],
  [
    51.501199,
    -0.09337,
    0.022782435025774213,
    "Borough"
  ],
  [
    51.495635,
    -0.324939,
    0.0022151668193986927,
    "Boston Manor"
  ],
  [
    51.490311,
    -0.213427,
    0.021259835897248627,
    "Barons Court"
  ],
  [
    51.522883,
    -0.15713,
    0.0923494686799846,
    "Baker Street"
  ],
  [
    51.602774,
    -0.264048,
    0.005798048805476679,
    "Burnt Oak"
  ],
  [
    51.57665,
    -0.213622,
    0.0027826280976025893,
    "Brent Cross"
  ],
  [
    51.52694,
    -0.025128,
    0.016382759446816633,
    "Bow Road"
  ],
  [
    51.512284,
    -0.187938,
    0.02508063802203763,
    "Bayswater"
  ],
  [
    51.462618,
    -0.114888,
    0.051449441345653234,
    "Brixton"
  ],
  [
    51.550311,
    -0.164648,
    0.010264506328061312,
    "Belsize Park"
  ],
  [
    51.667985,
    -0.560689,
    0.0008577070558001825,
    "Chalfont & Latimer"
  ],
  [
    51.548519,
    -0.118493,
    0.01078305348447335,
    "Caledonian Road"
  ],
  [
    51.544118,
    -0.153388,
    0.010313592578239352,
    "Chalk Farm"
  ],
  [
    51.513093,
    -0.124436,
    0.07501375974313673,
    "Covent Garden"
  ],
  [
    51.513584,
    0.008322,
    0.0,
    "Canning Town"
  ],
  [
    51.518247,
    -0.111583,
    0.03837153455571684,
    "Chancery Lane"
  ],
  [
    51.50741,
    -0.127277,
    0.06984047248599162,
    "Charing Cross"
  ],
  [
    51.65152,
    -0.149171,
    0.00742339255029835,
    "Cockfosters"
  ],
  [
    51.595424,
    -0.249919,
    0.003973394092629576,
    "Colindale"
  ],
  [
    51.461742,
    -0.138317,
    0.016053730126401218,
    "Clapham Common"
  ],
  [
    51.607701,
    -0.294693,
    0.0013664757284389101,
    "Canons Park"
  ],
  [
    51.465135,
    -0.130016,
    0.01009004641252072,
    "Clapham North"
  ],
  [
    51.452654,
    -0.147582,
    0.012243956486100716,
    "Clapham South"
  ],
  [
    51.41816,
    -0.178086,
    0.005575938398877511,
    "Colliers Wood"
  ],
  [
    51.705208,
    -0.611247,
    0.00042594222190974634,
    "Chesham"
  ],
  [
    51.51151,
    -0.090432,
    0.026633955782302616,
    "Cannon Street"
  ],
  [
    51.539292,
    -0.14274,
    0.07730904637121531,
    "Camden Town"
  ],
  [
    51.617916,
    0.075041,
    8.697755193480837e-05,
    "Chigwell"
  ],
  [
    51.494627,
    -0.267972,
    0.005363396515556956,
    "Chiswick Park"
  ],
  [
    51.497931,
    -0.049405,
    0.03027504695906734,
    "Canada Water"
  ],
  [
    51.647044,
    -0.441718,
    0.0005972197233780126,
    "Croxley"
  ],
  [
    51.654358,
    -0.518461,
    0.0007128617678896663,
    "Chorleywood"
  ],
  [
    51.503488,
    -0.018246,
    0.12017581618565917,
    "Canary Wharf"
  ],
  [
    51.645386,
    0.083782,
    0.002253926212163731,
    "Debden"
  ],
  [
    51.544096,
    0.166017,
    0.005194212802009812,
    "Dagenham East"
  ],
  [
    51.541639,
    0.147527,
    0.02204654907331028,
    "Dagenham Heathway"
  ],
  [
    51.551955,
    -0.239068,
    0.004617286202538934,
    "Dollis Hill"
  ],
  [
    51.494536,
    -0.100606,
    0.058721394348038226,
    "Elephant & Castle"
  ],
  [
    51.576506,
    -0.397373,
    0.0025847329246835426,
    "Eastcote"
  ],
  [
    51.516612,
    -0.247248,
    0.005825724805973677,
    "East Acton"
  ],
  [
    51.515017,
    -0.301457,
    0.03993343253363073,
    "Ealing Broadway"
  ],
  [
    51.51014,
    -0.288265,
    0.0033008509463272125,
    "Ealing Common"
  ],
  [
    51.492063,
    -0.193378,
    0.05595149109330537,
    "Earl's Court"
  ],
  [
    51.587131,
    -0.165012,
    0.010950006543255522,
    "East Finchley"
  ],
  [
    51.613653,
    -0.274928,
    0.0072507318103709,
    "Edgware"
  ],
  [
    51.538948,
    0.051186,
    0.033691456808119254,
    "East Ham"
  ],
  [
    51.507058,
    -0.122666,
    0.08181778464093388,
    "Embankment"
  ],
  [
    51.69368,
    0.113767,
    0.0026292255486224966,
    "Epping"
  ],
  [
    51.549775,
    0.19864,
    0.003987928367209022,
    "Elm Park"
  ],
  [
    51.459205,
    -0.211,
    0.004700755605610626,
    "East Putney"
  ],
  [
    51.520299,
    -0.17015,
    0.011413529164224608,
    "Edgware Road (Bakerloo)"
  ],
  [
    51.519858,
    -0.167832,
    0.02294211327827966,
    "Edgware Road (Circle Line)"
  ],
  [
    51.525604,
    -0.135829,
    0.040144144944708936,
    "Euston Square"
  ],
  [
    51.528055,
    -0.132182,
    0.17118256463581236,
    "Euston"
  ],
  [
    51.480081,
    -0.195422,
    0.013990083769489759,
    "Fulham Broadway"
  ],
  [
    51.520252,
    -0.104913,
    0.168928963505717,
    "Farringdon"
  ],
  [
    51.595618,
    0.091004,
    0.000702249276734115,
    "Fairlop"
  ],
  [
    51.564158,
    -0.106825,
    0.07322988624151089,
    "Finsbury Park"
  ],
  [
    51.600921,
    -0.192527,
    0.004952050988359936,
    "Finchley Central"
  ],
  [
    51.546825,
    -0.179845,
    0.0208962596922247,
    "Finchley Road"
  ],
  [
    51.491803,
    -0.275267,
    0.007863259500486393,
    "Gunnersbury"
  ],
  [
    51.520599,
    -0.134361,
    0.02099988145262909,
    "Goodge Street"
  ],
  [
    51.542424,
    -0.34605,
    0.006392404635115355,
    "Greenford"
  ],
  [
    51.613378,
    0.092066,
    0.00013549746403580812,
    "Grange Hill"
  ],
  [
    51.572259,
    -0.194039,
    0.020630564591749223,
    "Golders Green"
  ],
  [
    51.502005,
    -0.226715,
    0.004087927743748883,
    "Goldhawk Road"
  ],
  [
    51.506947,
    -0.142787,
    0.19187651691782254,
    "Green Park"
  ],
  [
    51.52384,
    -0.144262,
    0.03144170856140202,
    "Great Portland Street"
  ],
  [
    51.576544,
    0.066185,
    0.010774321255345004,
    "Gants Hill"
  ],
  [
    51.494316,
    -0.182658,
    0.04453848552856074,
    "Gloucester Road"
  ],
  [
    51.54635,
    -0.103324,
    0.023955688728654077,
    "Highbury & Islington"
  ],
  [
    51.592268,
    -0.335217,
    0.010793307640136855,
    "Harrow & Wealdstone"
  ],
  [
    51.51758,
    -0.120475,
    0.12806686951309318,
    "Holborn"
  ],
  [
    51.650541,
    -0.194298,
    0.003592674278943333,
    "High Barnet"
  ],
  [
    51.554093,
    0.219116,
    0.0020299537871574427,
    "Hornchurch"
  ],
  [
    51.583301,
    -0.226424,
    0.01182467087180777,
    "Hendon Central"
  ],
  [
    51.553715,
    -0.449828,
    0.0009444046294332097,
    "Hillingdon"
  ],
  [
    51.530177,
    -0.292704,
    0.005369238706470979,
    "Hanger Lane"
  ],
  [
    51.577532,
    -0.145857,
    0.005977131665156479,
    "Highgate"
  ],
  [
    51.603659,
    0.093482,
    0.0024910525340549913,
    "Hainault"
  ],
  [
    51.466747,
    -0.423191,
    0.013156783383285705,
    "Hatton Cross"
  ],
  [
    51.579195,
    -0.337225,
    0.013737193226882759,
    "Harrow-on-the-Hill"
  ],
  [
    51.503035,
    -0.152441,
    0.018716442528994095,
    "Hyde Park Corner"
  ],
  [
    51.507143,
    -0.205679,
    0.009177861695794607,
    "Holland Park"
  ],
  [
    51.458524,
    -0.445771,
    0.0037318215282698096,
    "Heathrow Terminal 4"
  ],
  [
    51.470052,
    -0.49056,
    0.0,
    "Heathrow Terminal 5"
  ],
  [
    51.471235,
    -0.452265,
    0.040312871491388895,
    "Heathrow Terminals 2 & 3"
  ],
  [
    51.49331,
    -0.2243,
    0.023513299438210077,
    "Hammersmith (H&C Line)"
  ],
  [
    51.4923,
    -0.22362,
    0.0,
    "Hammersmith (Dist&Picc Line)"
  ],
  [
    51.501055,
    -0.192792,
    0.03486907179007276,
    "High Street Kensington"
  ],
  [
    51.53631,
    -0.257883,
    0.002793412433200699,
    "Harlesden"
  ],
  [
    51.556239,
    -0.177464,
    0.008898263996017952,
    "Hampstead"
  ],
  [
    51.471295,
    -0.366578,
    0.008088009224652328,
    "Hounslow Central"
  ],
  [
    51.473213,
    -0.356474,
    0.006835340766922945,
    "Hounslow East"
  ],
  [
    51.473469,
    -0.386544,
    0.006736628322721611,
    "Hounslow West"
  ],
  [
    51.552697,
    -0.113244,
    0.017192400948175805,
    "Holloway Road"
  ],
  [
    51.561992,
    -0.442001,
    0.0005906386146172052,
    "Ickenham"
  ],
  [
    51.547183,
    -0.204248,
    0.010534413619935694,
    "Kilburn"
  ],
  [
    51.584845,
    -0.27879,
    0.003225708883250854,
    "Kingsbury"
  ],
  [
    51.581756,
    -0.31691,
    0.002789373968173925,
    "Kenton"
  ],
  [
    51.501669,
    -0.160508,
    0.09274326081289529,
    "Knightsbridge"
  ],
  [
    51.488337,
    -0.105963,
    0.013533866451613882,
    "Kennington"
  ],
  [
    51.497624,
    -0.210015,
    0.0,
    "Kensington (Olympia)"
  ],
  [
    51.534979,
    -0.194232,
    0.009167594955770181,
    "Kilburn Park"
  ],
  [
    51.550312,
    -0.140733,
    0.051362175094929706,
    "Kentish Town"
  ],
  [
    51.530539,
    -0.225016,
    0.0037685647546070837,
    "Kensal Green"
  ],
  [
    51.530663,
    -0.123194,
    0.54552746,
    "King's Cross St. Pancras"
  ],
  [
    51.477058,
    -0.285241,
    0.004877628551249921,
    "Kew Gardens"
  ],
  [
    51.517449,
    -0.210391,
    0.0,
    "Ladbroke Grove"
  ],
  [
    51.498808,
    -0.112315,
    0.007847168869237925,
    "Lambeth North"
  ],
  [
    51.641443,
    0.055476,
    0.0027458447986702266,
    "Loughton"
  ],
  [
    51.511723,
    -0.175494,
    0.01631492533282219,
    "Lancaster Gate"
  ],
  [
    51.505721,
    -0.088873,
    0.2098278358707926,
    "London Bridge"
  ],
  [
    51.513389,
    -0.217799,
    0.012487137283722395,
    "Latimer Road"
  ],
  [
    51.511386,
    -0.128426,
    0.1281159478803931,
    "Leicester Square"
  ],
  [
    51.517372,
    -0.083182,
    0.24903097493673879,
    "Liverpool Street"
  ],
  [
    51.556589,
    -0.005523,
    0.012786194764577355,
    "Leyton"
  ],
  [
    51.568324,
    0.008194,
    0.01580613687166837,
    "Leytonstone"
  ],
  [
    51.513424,
    -0.158953,
    0.03428624947654562,
    "Marble Arch"
  ],
  [
    51.402142,
    -0.194839,
    0.014305252685578867,
    "Morden"
  ],
  [
    51.525122,
    -0.03364,
    0.06925690797348938,
    "Mile End"
  ],
  [
    51.518176,
    -0.088322,
    0.09536431095753999,
    "Moorgate"
  ],
  [
    51.608229,
    -0.209986,
    0.0010662011100033033,
    "Mill Hill East"
  ],
  [
    51.5107,
    -0.085969,
    0.029909699245411103,
    "Monument"
  ],
  [
    51.629845,
    -0.432454,
    0.00040608533089783955,
    "Moor Park"
  ],
  [
    51.570738,
    -0.096118,
    0.01494332667468733,
    "Manor House"
  ],
  [
    51.512117,
    -0.094009,
    0.021309699047157262,
    "Mansion House"
  ],
  [
    51.534679,
    -0.138789,
    0.008725413921407597,
    "Mornington Crescent"
  ],
  [
    51.529777,
    -0.185758,
    0.006848022502083453,
    "Maida Vale"
  ],
  [
    51.522322,
    -0.163207,
    0.05625306391277073,
    "Marylebone"
  ],
  [
    51.523524,
    -0.259755,
    0.00834871782229886,
    "North Acton"
  ],
  [
    51.575726,
    0.090004,
    0.011013867984520321,
    "Newbury Park"
  ],
  [
    51.553986,
    -0.249837,
    0.0052144413554113716,
    "Neasden"
  ],
  [
    51.517505,
    -0.288868,
    0.0010166836814846916,
    "North Ealing"
  ],
  [
    51.499319,
    -0.314719,
    0.004125085856852365,
    "Northfields"
  ],
  [
    51.50047,
    0.004287,
    0.028783717604195392,
    "North Greenwich"
  ],
  [
    51.584872,
    -0.362408,
    0.001496145646385701,
    "North Harrow"
  ],
  [
    51.509128,
    -0.196104,
    0.053792055926795784,
    "Notting Hill Gate"
  ],
  [
    51.548236,
    -0.368699,
    0.007474672253705517,
    "Northolt"
  ],
  [
    51.578481,
    -0.318056,
    0.009638822242159397,
    "Northwick Park"
  ],
  [
    51.611053,
    -0.423829,
    0.0037951837579436394,
    "Northwood"
  ],
  [
    51.600572,
    -0.409464,
    0.0019984597006494314,
    "Northwood Hills"
  ],
  [
    51.562551,
    -0.304,
    0.003747740359126738,
    "North Wembley"
  ],
  [
    51.647726,
    -0.132182,
    0.0037969686411035786,
    "Oakwood"
  ],
  [
    51.525864,
    -0.08777,
    0.06703381740742649,
    "Old Street"
  ],
  [
    51.481274,
    -0.352224,
    0.0013815714053233368,
    "Osterley"
  ],
  [
    51.48185,
    -0.112439,
    0.009386311516481253,
    "Oval"
  ],
  [
    51.515224,
    -0.141903,
    0.33746347989544856,
    "Oxford Circus"
  ],
  [
    51.516581,
    -0.175689,
    0.14406354684603054,
    "Paddington"
  ],
  [
    51.518187,
    -0.178306,
    0.0,
    "Paddington (H&C Line)-Underground"
  ],
  [
    51.51005,
    -0.133798,
    0.15325694531018452,
    "Piccadilly Circus"
  ],
  [
    51.489097,
    -0.133761,
    0.0,
    "Pimlico"
  ],
  [
    51.527123,
    -0.284341,
    0.002190317401835257,
    "Park Royal"
  ],
  [
    51.531341,
    0.017451,
    0.011634598357632711,
    "Plaistow"
  ],
  [
    51.592901,
    -0.381161,
    0.0017128161272921773,
    "Pinner"
  ],
  [
    51.571972,
    -0.295107,
    0.006763483173516051,
    "Preston Road"
  ],
  [
    51.475277,
    -0.20117,
    0.011973106978916967,
    "Parsons Green"
  ],
  [
    51.536717,
    -0.323446,
    0.0026434094597416217,
    "Perivale"
  ],
  [
    51.468262,
    -0.208731,
    0.013796860689554854,
    "Putney Bridge"
  ],
  [
    51.594188,
    -0.286219,
    0.0023275968910755466,
    "Queensbury"
  ],
  [
    51.534158,
    -0.204574,
    0.009868595078201472,
    "Queen's Park"
  ],
  [
    51.510312,
    -0.187152,
    0.03608953291128883,
    "Queensway"
  ],
  [
    51.576243,
    0.04536,
    0.0024803897501189465,
    "Redbridge"
  ],
  [
    51.523344,
    -0.146444,
    0.013862997692594421,
    "Regent's Park"
  ],
  [
    51.640207,
    -0.473703,
    0.0028405313730184463,
    "Rickmansworth"
  ],
  [
    51.463237,
    -0.301336,
    0.03024497773332404,
    "Richmond"
  ],
  [
    51.560736,
    -0.41071,
    0.0011325841051757525,
    "Ruislip Gardens"
  ],
  [
    51.573202,
    -0.412973,
    0.001772609852143002,
    "Ruislip Manor"
  ],
  [
    51.571354,
    -0.421898,
    0.0024220230170828015,
    "Ruislip"
  ],
  [
    51.523073,
    -0.124285,
    0.025920925655477135,
    "Russell Square"
  ],
  [
    51.494122,
    -0.235881,
    0.00314583241962416,
    "Ravenscourt Park"
  ],
  [
    51.617199,
    0.043647,
    6.936108010764257e-05,
    "Roding Valley"
  ],
  [
    51.575147,
    -0.371127,
    0.009385108085314002,
    "Rayners Lane"
  ],
  [
    51.519113,
    -0.188748,
    0.004504952208763535,
    "Royal Oak"
  ],
  [
    51.504376,
    -0.218813,
    0.08383460883790278,
    "Shepherd's Bush (Central)"
  ],
  [
    51.505579,
    -0.226375,
    0.007325206824180785,
    "Shepherd's Bush Market"
  ],
  [
    51.501003,
    -0.307424,
    0.002365381707571042,
    "South Ealing"
  ],
  [
    51.494917,
    -0.245704,
    0.004220598055039533,
    "Stamford Brook"
  ],
  [
    51.445073,
    -0.206602,
    0.0,
    "Southfields"
  ],
  [
    51.521858,
    -0.046596,
    0.021468101018695018,
    "Stepney Green"
  ],
  [
    51.543959,
    -0.275892,
    0.004280166637836724,
    "Stonebridge Park"
  ],
  [
    51.632315,
    -0.127816,
    0.00860949299505123,
    "Southgate"
  ],
  [
    51.564888,
    -0.352492,
    0.0025969028952424534,
    "South Harrow"
  ],
  [
    51.499544,
    -0.133608,
    0.0,
    "St. James's Park"
  ],
  [
    51.534521,
    -0.173948,
    0.021133841890290654,
    "St. John's Wood"
  ],
  [
    51.494094,
    -0.174138,
    0.21691510833654057,
    "South Kensington"
  ],
  [
    51.570232,
    -0.308433,
    0.0024430365590746134,
    "South Kenton"
  ],
  [
    51.472184,
    -0.122644,
    0.026462016804876646,
    "Stockwell"
  ],
  [
    51.580678,
    0.02144,
    0.0018616461273527872,
    "Snaresbrook"
  ],
  [
    51.514936,
    -0.097567,
    0.04502959602849861,
    "St. Paul's"
  ],
  [
    51.556853,
    -0.398915,
    0.002664216314545383,
    "South Ruislip"
  ],
  [
    51.49227,
    -0.156377,
    0.11765886810119372,
    "Sloane Square"
  ],
  [
    51.541806,
    -0.003458,
    0.26276436286489224,
    "Stratford"
  ],
  [
    51.619839,
    -0.303266,
    0.004441192140759619,
    "Stanmore"
  ],
  [
    51.556946,
    -0.336435,
    0.0011469343741427537,
    "Sudbury Hill"
  ],
  [
    51.550815,
    -0.315745,
    0.0011283579333810129,
    "Sudbury Town"
  ],
  [
    51.58333,
    -0.072584,
    0.0,
    "Seven Sisters"
  ],
  [
    51.543681,
    -0.174894,
    0.016878864958346087,
    "Swiss Cottage"
  ],
  [
    51.591907,
    0.027338,
    0.008101878009703588,
    "South Woodford"
  ],
  [
    51.50427,
    -0.105331,
    0.04581971379443059,
    "Southwark"
  ],
  [
    51.415309,
    -0.192005,
    0.004593654991014634,
    "South Wimbledon"
  ],
  [
    51.630597,
    -0.17921,
    0.002413278908422,
    "Totteridge & Whetstone"
  ],
  [
    51.435678,
    -0.159736,
    0.008113237863998231,
    "Tooting Bec"
  ],
  [
    51.42763,
    -0.168374,
    0.026988235774938557,
    "Tooting Broadway"
  ],
  [
    51.516426,
    -0.13041,
    0.277450559237047,
    "Tottenham Court Road"
  ],
  [
    51.556822,
    -0.138433,
    0.008485946021558818,
    "Tufnell Park"
  ],
  [
    51.671759,
    0.103085,
    0.0007197816060258014,
    "Theydon Bois"
  ],
  [
    51.588108,
    -0.060241,
    0.04092944668790021,
    "Tottenham Hale"
  ],
  [
    51.511006,
    -0.11426,
    0.033982801272527806,
    "Temple"
  ],
  [
    51.495148,
    -0.254555,
    0.008423383236610594,
    "Turnham Green"
  ],
  [
    51.590272,
    -0.102953,
    0.041827780908234115,
    "Turnpike Lane"
  ],
  [
    51.509971,
    -0.076546,
    0.14961108939848053,
    "Tower Hill"
  ],
  [
    51.55856,
    0.235809,
    0.00042672736895760666,
    "Upminster Bridge"
  ],
  [
    51.53534,
    0.035263,
    0.030688108856206868,
    "Upton Park"
  ],
  [
    51.559063,
    0.250882,
    0.005794181657974247,
    "Upminster"
  ],
  [
    51.538372,
    0.10153,
    0.0068580271081062245,
    "Upney"
  ],
  [
    51.546565,
    -0.477949,
    0.011875587018646529,
    "Uxbridge"
  ],
  [
    51.496359,
    -0.143102,
    0.31255490847654865,
    "Victoria"
  ],
  [
    51.485743,
    -0.124204,
    0.09327697612480719,
    "Vauxhall"
  ],
  [
    51.657446,
    -0.417377,
    0.0026101950264106116,
    "Watford"
  ],
  [
    51.487268,
    -0.195599,
    0.016379034181483176,
    "West Brompton"
  ],
  [
    51.511959,
    -0.224297,
    0.016021738287446855,
    "White City"
  ],
  [
    51.609426,
    -0.188362,
    0.001053790934690179,
    "West Finchley"
  ],
  [
    51.528136,
    0.005055,
    0.02580821155666538,
    "West Ham"
  ],
  [
    51.546638,
    -0.191059,
    0.018806948370966813,
    "West Hampstead"
  ],
  [
    51.57971,
    -0.3534,
    0.0007297662215703327,
    "West Harrow"
  ],
  [
    51.549146,
    -0.221537,
    0.011590262425291153,
    "Willesden Green"
  ],
  [
    51.421207,
    -0.206573,
    0.027094769134313794,
    "Wimbledon"
  ],
  [
    51.434573,
    -0.199719,
    0.0051227676745024715,
    "Wimbledon Park"
  ],
  [
    51.532259,
    -0.244283,
    0.0,
    "Willesden Junction"
  ],
  [
    51.523263,
    -0.183783,
    0.006242548489306959,
    "Warwick Avenue"
  ],
  [
    51.490459,
    -0.206636,
    0.007351939465484377,
    "West Kensington"
  ],
  [
    51.509669,
    -0.22453,
    0.017081670419205955,
    "Wood Lane"
  ],
  [
    51.503299,
    -0.11478,
    0.36292737448519763,
    "Waterloo"
  ],
  [
    51.606899,
    0.03397,
    0.01060163141817256,
    "Woodford"
  ],
  [
    51.597479,
    -0.109886,
    0.02255497584648813,
    "Wood Green"
  ],
  [
    51.618014,
    -0.18542,
    0.0019304119153072449,
    "Woodside Park"
  ],
  [
    51.519518,
    -0.059971,
    0.052031584069688865,
    "Whitechapel"
  ],
  [
    51.569688,
    -0.437886,
    0.002853939748167319,
    "West Ruislip"
  ],
  [
    51.524951,
    -0.138321,
    0.06995119388067797,
    "Warren Street"
  ],
  [
    51.575501,
    0.028527,
    0.004444043920346929,
    "Wanstead"
  ],
  [
    51.50132,
    -0.124861,
    0.047027333374830664,
    "Westminster"
  ],
  [
    51.52111,
    -0.201065,
    0.005408853311772497,
    "Westbourne Park"
  ],
  [
    51.518001,
    -0.28098,
    0.0008316568271294407,
    "West Acton"
  ],
  [
    51.582965,
    -0.019885,
    0.029522483077631743,
    "Walthamstow Central"
  ],
  [
    51.552304,
    -0.296852,
    0.016717076289149983,
    "Wembley Central"
  ],
  [
    51.563198,
    -0.279262,
    0.0005965636588167196,
    "Wembley Park"
  ],
  [
    51.479912,
    -0.128476,
    0.010223850127916457,
    "Nine Elms"
  ]
]`);

        // Define the URL for your GeoJSON tube lines file
        // IMPORTANT: Place your 'TubeLines.geojson' file in a 'data/' folder
        // in your GitHub repository alongside your 'index.html' file.
        const tubeLinesGeoJSONUrl = 'data/TubeLines.geojson';

        // Ensure all scripts and the DOM are loaded before initializing the map
        window.onload = function() {
            // Filter out any entries that are not arrays, or don't have enough elements,
            // or have non-numeric/NaN lat/lon values at the very first step.
            const cleanStationData = stationData.filter(entry =>
                Array.isArray(entry) &&
                entry.length >= 4 &&
                typeof entry[0] === 'number' && !isNaN(entry[0]) && // Check lat
                typeof entry[1] === 'number' && !isNaN(entry[1])    // Check lon
            );

            console.log("Cleaned stationData for map:", cleanStationData); // For debugging

            // Initialize the map
            // Centered on London (approximate), zoom level adjusted to show most stations
            const map = L.map('map').setView([51.505, -0.09], 11);

            // Add CartoDB Positron tiles (light map)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            // Fetch and add Tube Lines GeoJSON
            fetch(tubeLinesGeoJSONUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(geojsonData => {
                    L.geoJson(geojsonData, {
                        style: function(feature) {
                            // You can style lines based on properties in your GeoJSON
                            // For example, if your GeoJSON has a 'line_name' property:
                            switch (feature.properties.line_name) {
                                case 'Central': return {color: '#DC241F', weight: 3};
                                case 'Victoria': return {color: '#00A0E2', weight: 3};
                                case 'Jubilee': return {color: '#868F98', weight: 3};
                                case 'Northern': return {color: '#000000', weight: 3};
                                case 'Piccadilly': return {color: '#0019A8', weight: 3};
                                case 'Bakerloo': return {color: '#B36305', weight: 3};
                                case 'District': return {color: '#007229', weight: 3};
                                case 'Hammersmith & City': return {color: '#F4A9BE', weight: 3};
                                case 'Metropolitan': return {color: '#751056', weight: 3};
                                case 'Circle': return {color: '#FFD300', weight: 3};
                                case 'Waterloo & City': return {color: '#76D0BD', weight: 3};
                                case 'DLR': return {color: '#00BFB3', weight: 3}; // DLR specific color
                                case 'Overground': return {color: '#EE7800', weight: 3}; // Overground specific color
                                case 'Elizabeth line': return {color: '#6950A1', weight: 3}; // Elizabeth line specific color
                                default: return {color: '#888888', weight: 2}; // Default for other lines
                            }
                        }
                    }).addTo(map);
                    console.log("Tube lines GeoJSON loaded.");
                })
                .catch(error => console.error('Error loading tube lines GeoJSON:', error));


            // Prepare data for heatmap: Leaflet.heat requires data in [lat, lon, intensity] format
            // The 'intensity' here is our 'crowding_metric'.
            const heatData = cleanStationData.map(station => {
                const lat = station[0];
                const lon = station[1];
                let crowdingMetric = station[2];

                // Ensure crowdingMetric is a valid number, default to 0 if not
                if (typeof crowdingMetric !== 'number' || isNaN(crowdingMetric)) {
                    crowdingMetric = 0;
                }

                return [lat, lon, crowdingMetric]; // Leaflet.heat only needs [lat, lon, intensity]
            });


            // Add heatmap layer
            // Adjust radius, blur, and gradient for better visualization.
            // Max intensity is set to the maximum crowding metric found in the data,
            // or a default if all are 0, to scale the heatmap colors effectively.
            const maxCrowding = Math.max(...heatData.map(d => d[2]));
            // To increase intensity, we make the 'max' value smaller,
            // so lower crowding metrics reach the 'red' part of the gradient sooner.
            // Adjust the factor (e.g., 0.75, 0.5) to control how much more intense it appears.
            const heatMax = maxCrowding > 0 ? maxCrowding * 0.75 : 1; // Adjusted factor for intensity

            L.heatLayer(heatData, {
                radius: 25,   // Radius of the individual heat points
                blur: 15,     // Amount of blur to apply
                // maxZoom: 13,  // REMOVED: To allow intensity to scale with zoom
                max: heatMax, // Max intensity value for color scaling
                gradient: {
                    0.0: '#FFFFCC', // Very light yellow/off-white
                    0.2: '#FFEDA0', // Light yellow
                    0.4: '#FED976', // Muted yellow-orange
                    0.6: '#FEB24C', // Orange
                    0.8: '#FD8D3C', // Darker orange
                    1.0: '#FC4E2A'  // Red-orange
                }
            }).addTo(map);

            // Add invisible circle markers for individual stations with popups for detailed info on click
            cleanStationData.forEach(station => {
                const lat = station[0];
                const lon = station[1];
                const crowdingMetric = station[2];
                const stationName = station[3];

                L.circleMarker([lat, lon], {
                    radius: 8,          // Increased radius to make them more clickable
                    fillOpacity: 0,     // Completely transparent fill
                    stroke: false,      // No border
                    interactive: true   // Crucial for popups to work on click
                })
                .bindPopup(`<b>Station:</b> ${stationName}<br><b>Crowding Metric:</b> ${crowdingMetric.toFixed(2)}`)
                .addTo(map);
            });

            // Adjust map view on window resize to ensure responsiveness
            window.addEventListener('resize', () => {
                map.invalidateSize();
            });
        }; // End of window.onload
    </script>
</body>
</html>
    